{"version":3,"sources":["../src/PenpalError.ts","../src/errorSerialization.ts","../src/Reply.ts","../src/namespace.ts","../src/guards.ts","../src/methodSerialization.ts","../src/connectCallHandler.ts","../src/generateId.ts","../src/CallOptions.ts","../src/connectRemoteProxy.ts","../src/getPromiseWithResolvers.ts","../src/PenpalBugError.ts","../src/backwardCompatibility.ts","../src/shakeHands.ts","../src/once.ts","../src/connect.ts","../src/messengers/WindowMessenger.ts","../src/messengers/WorkerMessenger.ts","../src/messengers/PortMessenger.ts","../src/ErrorCodeObj.ts","../src/debug.ts"],"names":["brand"],"mappings":"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","file":"penpal.js","sourcesContent":["import { ErrorCode } from './types.js';\n\nclass PenpalError extends Error {\n  public code: ErrorCode;\n\n  constructor(code: ErrorCode, message: string) {\n    super(message);\n    this.name = 'PenpalError';\n    this.code = code;\n  }\n}\n\nexport default PenpalError;\n","import { SerializedError } from './types.js';\nimport PenpalError from './PenpalError.js';\n\n/**\n * Converts an error object into a plain object.\n */\nexport const serializeError = (error: Error): SerializedError => ({\n  name: error.name,\n  message: error.message,\n  stack: error.stack,\n  penpalCode: error instanceof PenpalError ? error.code : undefined,\n});\n\n/**\n * Converts a plain object into an error object.\n */\nexport const deserializeError = ({\n  name,\n  message,\n  stack,\n  penpalCode,\n}: SerializedError): Error => {\n  const deserializedError = penpalCode\n    ? new PenpalError(penpalCode, message)\n    : new Error(message);\n\n  deserializedError.name = name;\n  deserializedError.stack = stack;\n\n  return deserializedError;\n};\n","const brand: unique symbol = Symbol('Reply');\n\nclass Reply<T = unknown> {\n  readonly value: T;\n  readonly transferables?: Transferable[];\n\n  // Allows TypeScript to distinguish between an actual instance of this\n  // class versus an object that looks structurally similar.\n  // eslint-disable-next-line no-unused-private-class-members\n  #brand = brand;\n\n  constructor(\n    value: T,\n    options?: {\n      transferables?: Transferable[];\n    }\n  ) {\n    this.value = value;\n    this.transferables = options?.transferables;\n  }\n}\n\nexport default Reply;\n","export default 'penpal' as const;\n","import namespace from './namespace.js';\nimport {\n  Ack2Message,\n  CallMessage,\n  Message,\n  ReplyMessage,\n  Ack1Message,\n  SynMessage,\n  DestroyMessage,\n} from './types.js';\n\nexport const isObject = (\n  value: unknown\n): value is Record<string | number | symbol, unknown> => {\n  return typeof value === 'object' && value !== null;\n};\n\nexport const isFunction = (value: unknown) => {\n  return typeof value === 'function';\n};\n\nexport const isMessage = (data: unknown): data is Message => {\n  return isObject(data) && data.namespace === namespace;\n};\n\nexport const isSynMessage = (message: Message): message is SynMessage => {\n  return message.type === 'SYN';\n};\n\nexport const isAck1Message = (message: Message): message is Ack1Message => {\n  return message.type === 'ACK1';\n};\n\nexport const isAck2Message = (message: Message): message is Ack2Message => {\n  return message.type === 'ACK2';\n};\n\nexport const isCallMessage = (message: Message): message is CallMessage => {\n  return message.type === 'CALL';\n};\n\nexport const isReplyMessage = (message: Message): message is ReplyMessage => {\n  return message.type === 'REPLY';\n};\n\nexport const isDestroyMessage = (\n  message: Message\n): message is DestroyMessage => {\n  return message.type === 'DESTROY';\n};\n","import { MethodPath, Methods } from './types.js';\nimport { isFunction, isObject } from './guards.js';\n\n// TODO: Used for backward-compatibility. Remove in next major version.\n/**\n * Given an object of (nested) keys to functions, extract paths to each function.\n *\n * @example\n * Given this Method object:\n * {\n *   one: {\n *     two: () => {}\n *   }\n *   three: () => {}\n * }\n *\n * the extracted MethodPath[] would be:\n * [\n *   ['one', 'two'],\n *   ['three']\n * ]\n */\nexport const extractMethodPathsFromMethods = (\n  methods: Methods,\n  currentPath: MethodPath = []\n) => {\n  const methodPaths: MethodPath[] = [];\n\n  for (const key of Object.keys(methods)) {\n    const value = methods[key];\n\n    if (isFunction(value)) {\n      methodPaths.push([...currentPath, key]);\n    } else if (isObject(value)) {\n      methodPaths.push(\n        ...extractMethodPathsFromMethods(value, [...currentPath, key])\n      );\n    }\n  }\n\n  return methodPaths;\n};\n\nexport const getMethodAtMethodPath = (\n  methodPath: MethodPath,\n  methods: Methods\n) => {\n  const result = methodPath.reduce<Methods | Function | undefined>(\n    (acc, pathSegment) => {\n      return isObject(acc) ? acc[pathSegment] : undefined;\n    },\n    methods\n  );\n\n  return isFunction(result) ? result : undefined;\n};\n\nexport const formatMethodPath = (methodPath: MethodPath) => {\n  return methodPath.join('.');\n};\n","import { serializeError } from './errorSerialization.js';\nimport { Message, ReplyMessage, Methods, Log } from './types.js';\nimport Reply from './Reply.js';\nimport Messenger from './messengers/Messenger.js';\nimport PenpalError from './PenpalError.js';\nimport {\n  formatMethodPath,\n  getMethodAtMethodPath,\n} from './methodSerialization.js';\nimport { isCallMessage } from './guards.js';\nimport namespace from './namespace.js';\n\nconst createErrorReplyMessage = (\n  channel: string | undefined,\n  callId: string,\n  error: unknown\n): ReplyMessage => ({\n  namespace,\n  channel,\n  type: 'REPLY',\n  callId,\n  isError: true,\n  ...(error instanceof Error\n    ? { value: serializeError(error), isSerializedErrorInstance: true }\n    : { value: error }),\n});\n\n/**\n * Listens for \"call\" messages from the remote, executes the corresponding method,\n * and responds with the return value or error.\n */\nconst connectCallHandler = (\n  messenger: Messenger,\n  methods: Methods,\n  channel: string | undefined,\n  log: Log | undefined\n) => {\n  let isDestroyed = false;\n\n  const handleMessage = async (message: Message) => {\n    if (isDestroyed) {\n      // It's possible to throw an error here, but it would only be catchable\n      // using window.onerror since we're in an asynchronously-called function.\n      // There is no method call the consumer is making that they could wrap in\n      // a try-catch. Even if the consumer were to catch the error somehow,\n      // the value of doing so is questionable.\n      return;\n    }\n\n    if (!isCallMessage(message)) {\n      return;\n    }\n\n    log?.(`Received ${formatMethodPath(message.methodPath)}() call`, message);\n\n    const { methodPath, args, id: callId } = message;\n    let replyMessage: ReplyMessage;\n    let transferables: Transferable[] | undefined;\n\n    try {\n      const method = getMethodAtMethodPath(methodPath, methods);\n\n      if (!method) {\n        throw new PenpalError(\n          'METHOD_NOT_FOUND',\n          `Method \\`${formatMethodPath(methodPath)}\\` is not found.`\n        );\n      }\n\n      let value: unknown = await method(...args);\n\n      if (value instanceof Reply) {\n        transferables = value.transferables;\n        value = await value.value;\n      }\n\n      replyMessage = {\n        namespace,\n        channel,\n        type: 'REPLY',\n        callId,\n        value,\n      };\n    } catch (error) {\n      replyMessage = createErrorReplyMessage(channel, callId, error);\n    }\n\n    // Although we checked this at the beginning of the function, we need to\n    // check it again because we've made async calls, and the connection may\n    // have been destroyed in the meantime.\n    if (isDestroyed) {\n      return;\n    }\n\n    try {\n      log?.(`Sending ${formatMethodPath(methodPath)}() reply`, replyMessage);\n      messenger.sendMessage(replyMessage, transferables);\n    } catch (error) {\n      // If a consumer attempts to send an object that's not\n      // cloneable (e.g., window), we want to ensure the receiver's promise\n      // gets rejected.\n      if ((error as Error).name === 'DataCloneError') {\n        replyMessage = createErrorReplyMessage(channel, callId, error as Error);\n        log?.(`Sending ${formatMethodPath(methodPath)}() reply`, replyMessage);\n        messenger.sendMessage(replyMessage);\n      }\n      throw error;\n    }\n  };\n\n  messenger.addMessageHandler(handleMessage);\n\n  return () => {\n    isDestroyed = true;\n    messenger.removeMessageHandler(handleMessage);\n  };\n};\n\nexport default connectCallHandler;\n","/**\n * @return A unique ID\n */\n// crypto.randomUUID is not available in insecure contexts.\nexport default crypto.randomUUID?.bind(crypto) ??\n  (() =>\n    new Array(4)\n      .fill(0)\n      .map(() =>\n        Math.floor(Math.random() * Number.MAX_SAFE_INTEGER).toString(16)\n      )\n      .join('-'));\n","const brand: unique symbol = Symbol('CallOptions');\n\nclass CallOptions {\n  readonly transferables?: Transferable[];\n  readonly timeout?: number;\n\n  // Allows TypeScript to distinguish between an actual instance of this\n  // class versus an object that looks structurally similar.\n  // eslint-disable-next-line no-unused-private-class-members\n  #brand = brand;\n\n  constructor(options?: { transferables?: Transferable[]; timeout?: number }) {\n    this.transferables = options?.transferables;\n    this.timeout = options?.timeout;\n  }\n}\n\nexport default CallOptions;\n","import generateId from './generateId.js';\nimport { deserializeError } from './errorSerialization.js';\nimport { formatMethodPath } from './methodSerialization.js';\nimport {\n  Message,\n  RemoteProxy,\n  Methods,\n  MethodPath,\n  CallMessage,\n  Log,\n} from './types.js';\nimport CallOptions from './CallOptions.js';\nimport Messenger from './messengers/Messenger.js';\nimport PenpalError from './PenpalError.js';\nimport { isReplyMessage } from './guards.js';\nimport namespace from './namespace.js';\n\ntype ReplyHandler = {\n  methodPath: MethodPath;\n  resolve: (value: unknown) => void;\n  reject: (reason: unknown) => void;\n  timeoutId?: number;\n};\n\nconst methodsToTreatAsNative = new Set(['apply', 'call', 'bind']);\n\nconst createRemoteProxy = (\n  callback: (path: MethodPath, args: unknown[]) => void,\n  log?: Log,\n  path: MethodPath = []\n): Methods => {\n  return new Proxy(\n    path.length\n      ? () => {\n          // Intentionally empty\n        }\n      : Object.create(null),\n    {\n      get(target, prop: string) {\n        // If a promise is resolved with this proxy object, the JavaScript\n        // runtime will look for a `then` property on this object to determine\n        // if it should be treated as a promise (to support promise chaining).\n        // If we don't return undefined here, the JavaScript runtime will treat\n        // this object as a promise and attempt to call `then`, which will\n        // then send a call message to the remote. This is not what we want.\n        if (prop === 'then') {\n          return;\n        }\n\n        // Because we're using a proxy and because Penpal supports developers\n        // exposing nested methods, we have a predicament. If a developer\n        // calls, for example, remote.auth.apply(), are they\n        // attempting to call a nested apply() method that a developer has\n        // explicitly exposed from the remote? Could they instead be attempting\n        // to call Function.prototype.apply() on the remote.auth() method?\n        // Without the remote telling the local Penpal which methods the\n        // developer has exposed, it has no way of knowing (and the main reason\n        // we use a proxy is so that Penpal doesn't have to communicate which\n        // methods are exposed). So, we treat certain methods as native methods\n        // and return the native method rather than a proxy. The downside of\n        // this is that if a developer has explicitly exposed a nested method\n        // with the same name as one of these native method names, the developer\n        // will be unable to call the exposed remote method because they will\n        // be calling the method on the Function prototype instead.\n        if (path.length && methodsToTreatAsNative.has(prop)) {\n          return Reflect.get(target, prop);\n        }\n\n        return createRemoteProxy(callback, log, [...path, prop]);\n      },\n      apply(target, _thisArg, args) {\n        return callback(path, args);\n      },\n    }\n  );\n};\n\nconst getDestroyedConnectionMethodCallError = (methodPath: MethodPath) => {\n  return new PenpalError(\n    'CONNECTION_DESTROYED',\n    `Method call ${formatMethodPath(\n      methodPath\n    )}() failed due to destroyed connection`\n  );\n};\n\n/**\n * Creates a proxy. When methods are called on the proxy, a \"call\" message will\n * be sent to the remote, the remote's corresponding method will be\n * executed, and the method's return value will be returned via a message.\n */\nconst connectRemoteProxy = <TMethods extends Methods>(\n  messenger: Messenger,\n  channel: string | undefined,\n  log: Log | undefined\n) => {\n  let isDestroyed = false;\n  const replyHandlers = new Map<string, ReplyHandler>();\n\n  const handleMessage = (message: Message) => {\n    if (!isReplyMessage(message)) {\n      return;\n    }\n\n    const { callId, value, isError, isSerializedErrorInstance } = message;\n    const replyHandler = replyHandlers.get(callId);\n\n    if (!replyHandler) {\n      return;\n    }\n\n    replyHandlers.delete(callId);\n    log?.(\n      `Received ${formatMethodPath(replyHandler.methodPath)}() call`,\n      message\n    );\n\n    if (isError) {\n      replyHandler.reject(\n        isSerializedErrorInstance ? deserializeError(value) : value\n      );\n    } else {\n      replyHandler.resolve(value);\n    }\n  };\n\n  messenger.addMessageHandler(handleMessage);\n\n  const remoteProxy = createRemoteProxy((methodPath, args) => {\n    if (isDestroyed) {\n      throw getDestroyedConnectionMethodCallError(methodPath);\n    }\n\n    const callId = generateId();\n    const lastArg = args[args.length - 1];\n    const lastArgIsOptions = lastArg instanceof CallOptions;\n    const { timeout, transferables } = lastArgIsOptions ? lastArg : {};\n    const argsWithoutOptions = lastArgIsOptions ? args.slice(0, -1) : args;\n\n    return new Promise((resolve, reject) => {\n      // We reference `window.setTimeout` instead of just `setTimeout`\n      // so that the TypeScript engine doesn't\n      // get confused when running tests. Something within\n      // Karma + @rollup/plugin-typescript leaks node types into source\n      // files when running tests. Node's setTimeout has a return type of\n      // Timeout rather than number, resulting in a build error when\n      // running tests if we don't disambiguate the browser setTimeout\n      // from node's setTimeout. There may be a better way to configure\n      // Karma + Rollup + Typescript to avoid node type leakage.\n      const timeoutId =\n        timeout !== undefined\n          ? window.setTimeout(() => {\n              replyHandlers.delete(callId);\n              reject(\n                new PenpalError(\n                  'METHOD_CALL_TIMEOUT',\n                  `Method call ${formatMethodPath(\n                    methodPath\n                  )}() timed out after ${timeout}ms`\n                )\n              );\n            }, timeout)\n          : undefined;\n\n      replyHandlers.set(callId, { methodPath, resolve, reject, timeoutId });\n\n      try {\n        const callMessage: CallMessage = {\n          namespace,\n          channel,\n          type: 'CALL',\n          id: callId,\n          methodPath,\n          args: argsWithoutOptions,\n        };\n        log?.(`Sending ${formatMethodPath(methodPath)}() call`, callMessage);\n        messenger.sendMessage(callMessage, transferables);\n      } catch (error) {\n        reject(\n          new PenpalError('TRANSMISSION_FAILED', (error as Error).message)\n        );\n      }\n    });\n  }, log) as RemoteProxy<TMethods>;\n\n  const destroy = () => {\n    isDestroyed = true;\n    messenger.removeMessageHandler(handleMessage);\n\n    for (const { methodPath, reject, timeoutId } of replyHandlers.values()) {\n      clearTimeout(timeoutId);\n      reject(getDestroyedConnectionMethodCallError(methodPath));\n    }\n\n    replyHandlers.clear();\n  };\n\n  return {\n    remoteProxy,\n    destroy,\n  };\n};\n\nexport default connectRemoteProxy;\n","// Just use the native Promise.withResolvers() once it gains a bit more\n// adoption. Safari was the last major browser to support it, which happened\n// on March 5, 2024 in Safari 17.4.\nconst getPromiseWithResolvers = <ResolvedValueType, RejectedValueType>() => {\n  let resolve: (value: ResolvedValueType) => void;\n  let reject: (error: RejectedValueType) => void;\n\n  const promise = new Promise<ResolvedValueType>((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n\n  return {\n    promise,\n    resolve: resolve!,\n    reject: reject!,\n  };\n};\n\nexport default getPromiseWithResolvers;\n","/**\n * Error class that is thrown when we've reached a situation that we believe to\n * be a bug in Penpal and not anything the consumer has done.\n */\nclass PenpalBugError extends Error {\n  constructor(message: string) {\n    super(\n      `You've hit a bug in Penpal. Please file an issue with the following information: ${message}`\n    );\n  }\n}\n\nexport default PenpalBugError;\n","import { Message, MethodPath } from './types.js';\nimport namespace from './namespace.js';\nimport {\n  isCallMessage,\n  isReplyMessage,\n  isAck1Message,\n  isObject,\n} from './guards.js';\nimport PenpalBugError from './PenpalBugError.js';\n\nexport const DEPRECATED_PENPAL_PARTICIPANT_ID = 'deprecated-penpal';\n\n// TODO: This file is used for backward-compatibility. Remove in next major version.\n\nenum DeprecatedMessageType {\n  Call = 'call',\n  Reply = 'reply',\n  Syn = 'syn',\n  SynAck = 'synAck',\n  Ack = 'ack',\n}\n\nenum DeprecatedResolution {\n  Fulfilled = 'fulfilled',\n  Rejected = 'rejected',\n}\n\ntype DeprecatedSynMessage = {\n  penpal: DeprecatedMessageType.Syn;\n};\n\ntype DeprecatedSynAckMessage = {\n  penpal: DeprecatedMessageType.SynAck;\n  methodNames: string[];\n};\n\ntype DeprecatedAckMessage = {\n  penpal: DeprecatedMessageType.Ack;\n  methodNames: string[];\n};\n\ntype DeprecatedCallMessage = {\n  penpal: DeprecatedMessageType.Call;\n  id: number;\n  methodName: string;\n  args: unknown[];\n};\n\ntype DeprecatedSerializedError = {\n  name: string;\n  message: string;\n  stack?: string;\n};\n\ntype DeprecatedReplyMessage = {\n  penpal: DeprecatedMessageType.Reply;\n  id: number;\n} & (\n  | {\n      resolution: DeprecatedResolution.Fulfilled;\n      returnValue: unknown;\n      returnValueIsError?: false;\n    }\n  | {\n      resolution: DeprecatedResolution.Rejected;\n      returnValue: unknown;\n      returnValueIsError?: false;\n    }\n  | {\n      resolution: DeprecatedResolution.Rejected;\n      returnValue: DeprecatedSerializedError;\n      returnValueIsError: true;\n    }\n);\n\nexport type DeprecatedMessage =\n  | DeprecatedSynMessage\n  | DeprecatedSynAckMessage\n  | DeprecatedAckMessage\n  | DeprecatedCallMessage\n  | DeprecatedReplyMessage;\n\nexport const isDeprecatedMessage = (\n  data: unknown\n): data is DeprecatedMessage => {\n  return isObject(data) && 'penpal' in data;\n};\n\nconst upgradeMethodPath = (methodPath: string): MethodPath =>\n  methodPath.split('.');\nconst downgradeMethodPath = (methodPath: MethodPath) => methodPath.join('.');\n\nconst getUnexpectedMessageError = (message: unknown) => {\n  return new PenpalBugError(\n    `Unexpected message to translate: ${JSON.stringify(message)}`\n  );\n};\n\nexport const upgradeMessage = (message: DeprecatedMessage): Message => {\n  if (message.penpal === DeprecatedMessageType.Syn) {\n    return {\n      namespace,\n      channel: undefined,\n      type: 'SYN',\n      participantId: DEPRECATED_PENPAL_PARTICIPANT_ID,\n    };\n  }\n\n  if (message.penpal === DeprecatedMessageType.Ack) {\n    return {\n      namespace,\n      channel: undefined,\n      type: 'ACK2',\n    };\n  }\n\n  if (message.penpal === DeprecatedMessageType.Call) {\n    return {\n      namespace,\n      channel: undefined,\n      type: 'CALL',\n      // Actually converting the ID to a string would break communication.\n      id: (message.id as unknown) as string,\n      methodPath: upgradeMethodPath(message.methodName),\n      args: message.args,\n    };\n  }\n\n  if (message.penpal === DeprecatedMessageType.Reply) {\n    if (message.resolution === DeprecatedResolution.Fulfilled) {\n      return {\n        namespace,\n        channel: undefined,\n        type: 'REPLY',\n        // Actually converting the ID to a string would break communication.\n        callId: (message.id as unknown) as string,\n        value: message.returnValue,\n      };\n    } else {\n      return {\n        namespace,\n        channel: undefined,\n        type: 'REPLY',\n        // Actually converting the ID to a string would break communication.\n        callId: (message.id as unknown) as string,\n        isError: true,\n        ...(message.returnValueIsError\n          ? {\n              value: message.returnValue,\n              isSerializedErrorInstance: true,\n            }\n          : {\n              value: message.returnValue,\n            }),\n      };\n    }\n  }\n\n  throw getUnexpectedMessageError(message);\n};\n\nexport const downgradeMessage = (message: Message): DeprecatedMessage => {\n  if (isAck1Message(message)) {\n    return {\n      penpal: DeprecatedMessageType.SynAck,\n      methodNames: message.methodPaths.map(downgradeMethodPath),\n    };\n  }\n\n  if (isCallMessage(message)) {\n    return {\n      penpal: DeprecatedMessageType.Call,\n      // Actually converting the ID to a number would break communication.\n      id: (message.id as unknown) as number,\n      methodName: downgradeMethodPath(message.methodPath),\n      args: message.args,\n    };\n  }\n\n  if (isReplyMessage(message)) {\n    if (message.isError) {\n      return {\n        penpal: DeprecatedMessageType.Reply,\n        // Actually converting the ID to a number would break communication.\n        id: (message.callId as unknown) as number,\n        resolution: DeprecatedResolution.Rejected,\n        ...(message.isSerializedErrorInstance\n          ? {\n              returnValue: message.value,\n              returnValueIsError: true,\n            }\n          : { returnValue: message.value }),\n      };\n    } else {\n      return {\n        penpal: DeprecatedMessageType.Reply,\n        // Actually converting the ID to a number would break communication.\n        id: (message.callId as unknown) as number,\n        resolution: DeprecatedResolution.Fulfilled,\n        returnValue: message.value,\n      };\n    }\n  }\n\n  throw getUnexpectedMessageError(message);\n};\n","import Messenger from './messengers/Messenger.js';\nimport {\n  Ack2Message,\n  Methods,\n  Message,\n  RemoteProxy,\n  Ack1Message,\n  SynMessage,\n  Log,\n} from './types.js';\nimport PenpalError from './PenpalError.js';\nimport connectCallHandler from './connectCallHandler.js';\nimport connectRemoteProxy from './connectRemoteProxy.js';\nimport { isAck2Message, isAck1Message, isSynMessage } from './guards.js';\nimport getPromiseWithResolvers from './getPromiseWithResolvers.js';\nimport { extractMethodPathsFromMethods } from './methodSerialization.js';\nimport generateId from './generateId.js';\nimport { DEPRECATED_PENPAL_PARTICIPANT_ID } from './backwardCompatibility.js';\nimport namespace from './namespace.js';\n\ntype Options = {\n  messenger: Messenger;\n  methods: Methods;\n  timeout: number | undefined;\n  channel: string | undefined;\n  log: Log | undefined;\n};\n\ntype HandshakeResult<TMethods extends Methods> = {\n  remoteProxy: RemoteProxy<TMethods>;\n  destroy: () => void;\n};\n\n/**\n * Attempts to establish communication with the remote via a handshake protocol.\n * The handshake protocol fulfills a few requirements:\n *\n * 1. One participant in the handshake may not be available when the other\n *    participant starts the handshake. For example, a document inside an iframe\n *    may not be loaded when the parent window starts a handshake.\n * 2. While #1 could be solved by having the consumer of Penpal specify which\n *    participant should initiate the handshake, we'd rather avoid this\n *    unnecessary cognitive load.\n * 3. While #1 could be solved by having the consumer of Penpal specify which\n *    participant is the \"parent\" or \"child\" and then having Penpal assume\n *    the child should initiate the handshake, we'd rather avoid parent-child\n *    terminology since Penpal can support communication between two\n *    participants where neither would be considered a parent nor child. It may\n *    also be too presumptive that the child should always initiate the\n *    handshake.\n * 4. For robustness, each participant must know that the other participant is\n *    receiving its messages for the handshake to be considered complete.\n * 5. The handshake should support a participant attempting to\n *    re-establish the connection. This can occur, for example, if an end user\n *    were to right-click within an iframe and click reload.\n * 6. The handshake should allow a Messenger to easily attach something to\n *    a handshake message from one participant to the other unidirectionally\n *    (rather than from both participants to each other).\n *    This is important when a participant needs to be in charge of, for\n *    example, creating a MessageChannel and sending one MessagePort from the\n *    MessagePort pair to the other participant. If both participants attempted\n *    to do this it could lead to confusion.\n * 7. The handshake ideally shouldn't require sending handshake messages on an\n *    interval (retrying until the other participant is ready to receive them).\n *    Intervals can increase compute resources if the interval is too short\n *    or increase latency if the interval is too long. While we could make this\n *    configurable, it's additional mental load for the consumer. Additionally,\n *    setInterval and setTimeout are not available within some contexts\n *    (like AudioWorklet), where a consumer may like to use Penpal.\n *\n * To accomplish these requirements, the handshake protocol is as follows:\n * 1. Each participant generates a random participant ID.\n * 2. As soon as possible, each participant sends a SYN message containing its\n *    participant ID to the other participant.\n * 3. When the SYN messages were sent, one of the participants may not have\n *    been ready to receive the SYN message from the other. At least one\n *    of the participants was ready, however, and should have received a SYN\n *    message from the other participant. Each participant that did receive\n *    a SYN message knows for sure that the other participant is now ready\n *    to receive a SYN message, so it will send another SYN message in case\n *    the other participant did not receive the first SYN message. This\n *    ultimately results in each participant sending two SYN messages.\n * 4. Each participant now should have received at least one SYN message from\n *    the other participant. Each participant compares their own ID with the\n *    other participant's ID. Whichever participant has the higher ID\n *    (using a simple string comparison) is considered the handshake leader\n *    and will send an ACK1 message to the other participant.\n * 5. At this point, the handshake leader does not know whether the other\n *    participant is actually receiving messages. The participant receiving\n *    the ACK1 message will respond with an ACK2, informing the handshake\n *    leader that it is indeed receiving messages.\n * 6. At this point, both participants know the other is receiving messages\n *    and the handshake is complete.\n */\nconst shakeHands = <TMethods extends Methods>({\n  messenger,\n  methods,\n  timeout,\n  channel,\n  log,\n}: Options): Promise<HandshakeResult<TMethods>> => {\n  const participantId = generateId();\n  let remoteParticipantId: string;\n  const destroyHandlers: (() => void)[] = [];\n  let isComplete = false;\n\n  const methodPaths = extractMethodPathsFromMethods(methods);\n\n  const { promise, resolve, reject } = getPromiseWithResolvers<\n    HandshakeResult<TMethods>,\n    PenpalError\n  >();\n\n  const timeoutId =\n    timeout !== undefined\n      ? setTimeout(() => {\n          reject(\n            new PenpalError(\n              'CONNECTION_TIMEOUT',\n              `Connection timed out after ${timeout}ms`\n            )\n          );\n        }, timeout)\n      : undefined;\n\n  const destroy = () => {\n    for (const destroyHandler of destroyHandlers) {\n      destroyHandler();\n    }\n  };\n\n  const connectCallHandlerAndMethodProxies = () => {\n    if (isComplete) {\n      // If we get here, it means the remote is attempting to re-connect. While\n      // that's supported, we don't need to run the rest of this function again.\n      return;\n    }\n\n    destroyHandlers.push(connectCallHandler(messenger, methods, channel, log));\n\n    const { remoteProxy, destroy: destroyMethodProxies } = connectRemoteProxy<\n      TMethods\n    >(messenger, channel, log);\n\n    destroyHandlers.push(destroyMethodProxies);\n\n    clearTimeout(timeoutId);\n    isComplete = true;\n\n    resolve({\n      remoteProxy,\n      destroy: destroy,\n    });\n  };\n\n  const sendSynMessage = () => {\n    const synMessage: SynMessage = {\n      namespace,\n      type: 'SYN',\n      channel,\n      participantId: participantId,\n    };\n    log?.(`Sending handshake SYN`, synMessage);\n\n    try {\n      messenger.sendMessage(synMessage);\n    } catch (error) {\n      reject(new PenpalError('TRANSMISSION_FAILED', (error as Error).message));\n    }\n  };\n\n  const handleSynMessage = (message: SynMessage) => {\n    log?.(`Received handshake SYN`, message);\n\n    if (\n      message.participantId === remoteParticipantId &&\n      // TODO: Used for backward-compatibility. Remove in next major version.\n      remoteParticipantId !== DEPRECATED_PENPAL_PARTICIPANT_ID\n    ) {\n      return;\n    }\n\n    remoteParticipantId = message.participantId;\n\n    // We send another SYN message in case the other participant was not ready\n    // when we sent the first SYN message.\n    sendSynMessage();\n\n    const isHandshakeLeader =\n      participantId > remoteParticipantId ||\n      // TODO: Used for backward-compatibility. Remove in next major version.\n      remoteParticipantId === DEPRECATED_PENPAL_PARTICIPANT_ID;\n\n    if (!isHandshakeLeader) {\n      return;\n    }\n\n    const ack1Message: Ack1Message = {\n      namespace,\n      channel,\n      type: 'ACK1',\n      methodPaths,\n    };\n    log?.(`Sending handshake ACK1`, ack1Message);\n\n    try {\n      messenger.sendMessage(ack1Message);\n    } catch (error) {\n      reject(new PenpalError('TRANSMISSION_FAILED', (error as Error).message));\n      return;\n    }\n  };\n\n  const handleAck1Message = (message: Ack1Message) => {\n    log?.(`Received handshake ACK1`, message);\n    const ack2Message: Ack2Message = {\n      namespace,\n      channel,\n      type: 'ACK2',\n    };\n    log?.(`Sending handshake ACK2`, ack2Message);\n\n    try {\n      messenger.sendMessage(ack2Message);\n    } catch (error) {\n      reject(new PenpalError('TRANSMISSION_FAILED', (error as Error).message));\n      return;\n    }\n\n    connectCallHandlerAndMethodProxies();\n  };\n\n  const handleAck2Message = (message: Ack2Message) => {\n    log?.(`Received handshake ACK2`, message);\n    connectCallHandlerAndMethodProxies();\n  };\n\n  const handleMessage = (message: Message) => {\n    if (isSynMessage(message)) {\n      handleSynMessage(message);\n    }\n\n    if (isAck1Message(message)) {\n      handleAck1Message(message);\n    }\n\n    if (isAck2Message(message)) {\n      handleAck2Message(message);\n    }\n  };\n\n  messenger.addMessageHandler(handleMessage);\n  destroyHandlers.push(() => messenger.removeMessageHandler(handleMessage));\n\n  sendSynMessage();\n\n  return promise;\n};\n\nexport default shakeHands;\n","// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst once = <T extends (...args: any[]) => any>(\n  fn: T\n): ((...args: Parameters<T>) => ReturnType<T>) => {\n  let isCalled = false;\n  let result: ReturnType<T>;\n\n  return (...args: Parameters<T>): ReturnType<T> => {\n    if (!isCalled) {\n      isCalled = true;\n      result = fn(...args);\n    }\n    return result;\n  };\n};\n\nexport default once;\n","import { DestroyMessage, Connection, Log, Message, Methods } from './types.js';\r\nimport PenpalError from './PenpalError.js';\r\nimport Messenger from './messengers/Messenger.js';\r\nimport shakeHands from './shakeHands.js';\r\nimport { isDestroyMessage, isMessage } from './guards.js';\r\nimport once from './once.js';\r\nimport namespace from './namespace.js';\r\n\r\ntype Options = {\r\n  /**\r\n   * Messenger in charge of handling communication with the remote.\r\n   */\r\n  messenger: Messenger;\r\n  /**\r\n   * Methods that may be called by the remote.\r\n   */\r\n  methods?: Methods;\r\n  /**\r\n   * The amount of time, in milliseconds, Penpal should wait\r\n   * for a connection to be established before rejecting the connection promise.\r\n   */\r\n  timeout?: number;\r\n  /**\r\n   * A string identifier that disambiguates communication when establishing\r\n   * multiple, parallel connections between two participants (e.g., two windows,\r\n   * a window and a worker).\r\n   */\r\n  channel?: string;\r\n  /**\r\n   * A function for logging debug messages. Debug messages will only be\r\n   * logged when this is defined.\r\n   */\r\n  log?: Log;\r\n};\r\n\r\nconst usedMessengers = new WeakSet<Messenger>();\r\n\r\n/**\r\n * Attempts to establish communication with the remote.\r\n */\r\nconst connect = <TMethods extends Methods>({\r\n  messenger,\r\n  methods = {},\r\n  timeout,\r\n  channel,\r\n  log,\r\n}: Options): Connection<TMethods> => {\r\n  if (!messenger) {\r\n    throw new PenpalError('INVALID_ARGUMENT', 'messenger must be defined');\r\n  }\r\n\r\n  if (usedMessengers.has(messenger)) {\r\n    throw new PenpalError(\r\n      'INVALID_ARGUMENT',\r\n      'A messenger can only be used for a single connection'\r\n    );\r\n  }\r\n\r\n  usedMessengers.add(messenger);\r\n\r\n  const connectionDestroyedHandlers: (() => void)[] = [messenger.destroy];\r\n\r\n  const destroyConnection = once((notifyOtherParticipant: boolean) => {\r\n    if (notifyOtherParticipant) {\r\n      const destroyMessage: DestroyMessage = {\r\n        namespace,\r\n        channel,\r\n        type: 'DESTROY',\r\n      };\r\n\r\n      try {\r\n        messenger.sendMessage(destroyMessage);\r\n      } catch (_) {\r\n        // We do our best to notify the other participant of the connection, but\r\n        // if there's an error in doing so (e.g., maybe the handshake hasn't\r\n        // completed and a messenger can't send the message), it's probably not\r\n        // worth bothering the consumer with an error.\r\n      }\r\n    }\r\n\r\n    for (const connectionDestroyedHandler of connectionDestroyedHandlers) {\r\n      connectionDestroyedHandler();\r\n    }\r\n\r\n    log?.('Connection destroyed');\r\n  });\r\n\r\n  const validateReceivedMessage = (data: unknown): data is Message => {\r\n    return isMessage(data) && data.channel === channel;\r\n  };\r\n\r\n  const promise = (async () => {\r\n    try {\r\n      messenger.initialize({ log, validateReceivedMessage });\r\n      messenger.addMessageHandler((message) => {\r\n        if (isDestroyMessage(message)) {\r\n          destroyConnection(false);\r\n        }\r\n      });\r\n\r\n      const { remoteProxy, destroy } = await shakeHands<TMethods>({\r\n        messenger,\r\n        methods,\r\n        timeout,\r\n        channel,\r\n        log,\r\n      });\r\n      connectionDestroyedHandlers.push(destroy);\r\n      return remoteProxy;\r\n    } catch (error) {\r\n      destroyConnection(true);\r\n      throw error as PenpalError;\r\n    }\r\n  })();\r\n\r\n  return {\r\n    promise,\r\n    // Why we don't reject the connection promise when consumer calls destroy():\r\n    // https://github.com/Aaronius/penpal/issues/51\r\n    destroy: () => {\r\n      destroyConnection(true);\r\n    },\r\n    getOrigin() {\r\n      return messenger.getConcreteRemoteOrigin?.() || '';\r\n    },\r\n  };\r\n};\r\n\r\nexport default connect;\r\n","import { Log, Message } from '../types.js';\r\nimport Messenger, {\r\n  InitializeMessengerOptions,\r\n  MessageHandler,\r\n} from './Messenger.js';\r\nimport {\r\n  downgradeMessage,\r\n  isDeprecatedMessage,\r\n  upgradeMessage,\r\n} from '../backwardCompatibility.js';\r\nimport { isAck2Message, isAck1Message, isSynMessage } from '../guards.js';\r\nimport PenpalError from '../PenpalError.js';\r\nimport PenpalBugError from '../PenpalBugError.js';\r\n\r\ntype Options = {\r\n  /**\r\n   * The window with which the current window will communicate.\r\n   */\r\n  remoteWindow: Window;\r\n  /**\r\n   * An array of strings or regular expressions defining to which origins\r\n   * communication will be allowed. If not provided, communication will be\r\n   * restricted to the origin of the current page. You may specify an allowed\r\n   * origin of `*` to not restrict communication, but beware the risks of\r\n   * doing so.\r\n   */\r\n  allowedOrigins?: (string | RegExp)[];\r\n};\r\n\r\n/**\r\n * Handles the details of communicating with a child window.\r\n */\r\nclass WindowMessenger implements Messenger {\r\n  readonly #remoteWindow: Window;\r\n  readonly #allowedOrigins: [string | RegExp, ...(string | RegExp)[]];\r\n  #log?: Log;\r\n  #validateReceivedMessage?: (data: unknown) => data is Message;\r\n  #concreteRemoteOrigin?: string;\r\n  #messageCallbacks = new Set<(message: Message) => void>();\r\n  #port?: MessagePort;\r\n  // TODO: Used for backward-compatibility. Remove in next major version.\r\n  #isChildUsingDeprecatedProtocol = false;\r\n\r\n  constructor({ remoteWindow, allowedOrigins }: Options) {\r\n    if (!remoteWindow) {\r\n      throw new PenpalError('INVALID_ARGUMENT', 'remoteWindow must be defined');\r\n    }\r\n\r\n    this.#remoteWindow = remoteWindow;\r\n    this.#allowedOrigins = allowedOrigins?.length\r\n      ? (allowedOrigins as [string | RegExp, ...(string | RegExp)[]])\r\n      : [window.origin];\r\n  }\r\n\r\n  initialize = ({\r\n    log,\r\n    validateReceivedMessage,\r\n  }: InitializeMessengerOptions) => {\r\n    this.#log = log;\r\n    this.#validateReceivedMessage = validateReceivedMessage;\r\n    window.addEventListener('message', this.#handleMessageFromRemoteWindow);\r\n  };\r\n\r\n  sendMessage = (message: Message, transferables?: Transferable[]): void => {\r\n    if (isSynMessage(message)) {\r\n      const originForSending = this.#getOriginForSendingMessage(message);\r\n      this.#remoteWindow.postMessage(message, {\r\n        targetOrigin: originForSending,\r\n        transfer: transferables,\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (\r\n      isAck1Message(message) ||\r\n      // If the child is using a previous version of Penpal, we need to\r\n      // downgrade the message and send it through the window rather than\r\n      // the port because older versions of Penpal don't use MessagePorts.\r\n      this.#isChildUsingDeprecatedProtocol\r\n    ) {\r\n      const payload = this.#isChildUsingDeprecatedProtocol\r\n        ? downgradeMessage(message)\r\n        : message;\r\n      const originForSending = this.#getOriginForSendingMessage(message);\r\n      this.#remoteWindow.postMessage(payload, {\r\n        targetOrigin: originForSending,\r\n        transfer: transferables,\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (isAck2Message(message)) {\r\n      const { port1, port2 } = new MessageChannel();\r\n      this.#port = port1;\r\n      port1.addEventListener('message', this.#handleMessageFromPort);\r\n      port1.start();\r\n      const transferablesToSend = [port2, ...(transferables || [])];\r\n      const originForSending = this.#getOriginForSendingMessage(message);\r\n      this.#remoteWindow.postMessage(message, {\r\n        targetOrigin: originForSending,\r\n        transfer: transferablesToSend,\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (this.#port) {\r\n      this.#port.postMessage(message, {\r\n        transfer: transferables,\r\n      });\r\n      return;\r\n    }\r\n\r\n    throw new PenpalBugError('Port is undefined');\r\n  };\r\n\r\n  addMessageHandler = (callback: MessageHandler): void => {\r\n    this.#messageCallbacks.add(callback);\r\n  };\r\n\r\n  removeMessageHandler = (callback: MessageHandler): void => {\r\n    this.#messageCallbacks.delete(callback);\r\n  };\r\n\r\n  destroy = () => {\r\n    window.removeEventListener('message', this.#handleMessageFromRemoteWindow);\r\n    this.#destroyPort();\r\n    this.#messageCallbacks.clear();\r\n  };\r\n\r\n  getConcreteRemoteOrigin = (): string | undefined => {\r\n    return this.#concreteRemoteOrigin;\r\n  };\r\n\r\n  #isAllowedOrigin = (origin: string) => {\r\n    return this.#allowedOrigins.some((allowedOrigin) =>\r\n      allowedOrigin instanceof RegExp\r\n        ? allowedOrigin.test(origin)\r\n        : allowedOrigin === origin || allowedOrigin === '*'\r\n    );\r\n  };\r\n\r\n  #getOriginForSendingMessage = (message: Message) => {\r\n    // It's safe to send the SYN message to any origin because it doesn't contain\r\n    // anything sensitive. When Penpal receives a SYN message, the origin on\r\n    // the message (which we call the concrete origin) is validated against the\r\n    // configured allowed origins. All subsequent messages will be sent to the\r\n    // concrete origin.\r\n    // If you decide to change this, consider https://github.com/Aaronius/penpal/issues/103\r\n    if (isSynMessage(message)) {\r\n      return '*';\r\n    }\r\n\r\n    if (!this.#concreteRemoteOrigin) {\r\n      throw new PenpalBugError('Concrete remote origin not set');\r\n    }\r\n\r\n    // If the concrete remote origin (the origin we received from the remote\r\n    // on a prior message) is 'null', it means the remote is within\r\n    // an \"opaque origin\". The only way to post a message to an\r\n    // opaque origin is by using '*'. This does carry some security risk,\r\n    // so we only do this if the consumer has specifically defined '*' as\r\n    // an allowed origin. Opaque origins occur, for example, when\r\n    // loading an HTML document directly from the filesystem (not a\r\n    // web server) or through a data URI.\r\n    return this.#concreteRemoteOrigin === 'null' &&\r\n      this.#allowedOrigins.includes('*')\r\n      ? '*'\r\n      : this.#concreteRemoteOrigin;\r\n  };\r\n\r\n  #destroyPort = () => {\r\n    this.#port?.removeEventListener('message', this.#handleMessageFromPort);\r\n    this.#port?.close();\r\n    this.#port = undefined;\r\n  };\r\n\r\n  #handleMessageFromRemoteWindow = ({\r\n    source,\r\n    origin,\r\n    ports,\r\n    data,\r\n  }: MessageEvent): void => {\r\n    if (source !== this.#remoteWindow) {\r\n      return;\r\n    }\r\n\r\n    // TODO: Used for backward-compatibility. Remove in next major version.\r\n    if (isDeprecatedMessage(data)) {\r\n      this.#log?.(\r\n        'Please upgrade the child window to the latest version of Penpal.'\r\n      );\r\n      this.#isChildUsingDeprecatedProtocol = true;\r\n      data = upgradeMessage(data);\r\n    }\r\n\r\n    if (!this.#validateReceivedMessage?.(data)) {\r\n      return;\r\n    }\r\n\r\n    if (!this.#isAllowedOrigin(origin)) {\r\n      this.#log?.(\r\n        `Received a message from origin \\`${origin}\\` which did not match ` +\r\n          `allowed origins \\`[${this.#allowedOrigins.join(', ')}]\\``\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (isSynMessage(data)) {\r\n      // If we receive a SYN message and already have a port, it means\r\n      // the child is re-connecting, in which case we'll receive a new port.\r\n      // For this reason, we always make sure we destroy the existing port.\r\n      this.#destroyPort();\r\n      this.#concreteRemoteOrigin = origin;\r\n    }\r\n\r\n    if (\r\n      isAck2Message(data) &&\r\n      // Previous versions of Penpal don't use MessagePorts and do all\r\n      // communication through the window.\r\n      !this.#isChildUsingDeprecatedProtocol\r\n    ) {\r\n      this.#port = ports[0];\r\n\r\n      if (!this.#port) {\r\n        throw new PenpalBugError('No port received on ACK2');\r\n      }\r\n\r\n      this.#port.addEventListener('message', this.#handleMessageFromPort);\r\n      this.#port.start();\r\n    }\r\n\r\n    for (const callback of this.#messageCallbacks) {\r\n      callback(data);\r\n    }\r\n  };\r\n\r\n  #handleMessageFromPort = ({ data }: MessageEvent): void => {\r\n    // Unlike in _handleMessageFromWindow, we don't need to check if\r\n    // the message is from a deprecated version of Penpal because older versions\r\n    // of Penpal don't use MessagePorts.\r\n    if (!this.#validateReceivedMessage?.(data)) {\r\n      return;\r\n    }\r\n\r\n    for (const callback of this.#messageCallbacks) {\r\n      callback(data);\r\n    }\r\n  };\r\n}\r\n\r\nexport default WindowMessenger;\r\n","import { Message } from '../types.js';\nimport Messenger, {\n  InitializeMessengerOptions,\n  MessageHandler,\n} from './Messenger.js';\nimport { isAck2Message, isAck1Message, isSynMessage } from '../guards.js';\nimport PenpalError from '../PenpalError.js';\nimport PenpalBugError from '../PenpalBugError.js';\n\n// This is needed to resolve some conflict errors. There may be a better way.\ntype MessageTarget = Pick<\n  Worker,\n  'postMessage' | 'addEventListener' | 'removeEventListener'\n>;\n\ntype Options = {\n  /**\n   * The web worker receiving/sending communication from/to the parent window.\n   * If this messenger is being used within the worker, `worker` should\n   * typically be set to `self`.\n   */\n  worker: Worker | DedicatedWorkerGlobalScope;\n};\n\n/**\n * Handles the details of communicating with a child web worker.\n */\nclass WorkerMessenger implements Messenger {\n  #worker: MessageTarget;\n  #validateReceivedMessage?: (data: unknown) => data is Message;\n  #messageCallbacks = new Set<MessageHandler>();\n  #port?: MessagePort;\n\n  constructor({ worker }: Options) {\n    if (!worker) {\n      throw new PenpalError('INVALID_ARGUMENT', 'worker must be defined');\n    }\n\n    this.#worker = worker;\n  }\n\n  initialize = ({ validateReceivedMessage }: InitializeMessengerOptions) => {\n    this.#validateReceivedMessage = validateReceivedMessage;\n    this.#worker.addEventListener('message', this.#handleMessage);\n  };\n\n  sendMessage = (message: Message, transferables?: Transferable[]): void => {\n    if (isSynMessage(message) || isAck1Message(message)) {\n      this.#worker.postMessage(message, { transfer: transferables });\n      return;\n    }\n\n    if (isAck2Message(message)) {\n      const { port1, port2 } = new MessageChannel();\n      this.#port = port1;\n      port1.addEventListener('message', this.#handleMessage);\n      port1.start();\n\n      this.#worker.postMessage(message, {\n        transfer: [port2, ...(transferables || [])],\n      });\n      return;\n    }\n\n    if (this.#port) {\n      this.#port.postMessage(message, {\n        transfer: transferables,\n      });\n      return;\n    }\n\n    throw new PenpalBugError('Port is undefined');\n  };\n\n  addMessageHandler = (callback: MessageHandler): void => {\n    this.#messageCallbacks.add(callback);\n  };\n\n  removeMessageHandler = (callback: MessageHandler): void => {\n    this.#messageCallbacks.delete(callback);\n  };\n\n  destroy = () => {\n    this.#worker.removeEventListener('message', this.#handleMessage);\n    this.#destroyPort();\n    this.#messageCallbacks.clear();\n  };\n\n  #destroyPort = () => {\n    this.#port?.removeEventListener('message', this.#handleMessage);\n    this.#port?.close();\n    this.#port = undefined;\n  };\n\n  #handleMessage = ({ ports, data }: MessageEvent): void => {\n    if (!this.#validateReceivedMessage?.(data)) {\n      return;\n    }\n\n    if (isSynMessage(data)) {\n      // If we receive a SYN message and already have a port, it means\n      // the child is re-connecting, in which case we'll receive a new port.\n      // For this reason, we always make sure we destroy the existing port.\n      this.#destroyPort();\n    }\n\n    if (isAck2Message(data)) {\n      this.#port = ports[0];\n\n      if (!this.#port) {\n        throw new PenpalBugError('No port received on ACK2');\n      }\n\n      this.#port.addEventListener('message', this.#handleMessage);\n      this.#port.start();\n    }\n\n    for (const callback of this.#messageCallbacks) {\n      callback(data);\n    }\n  };\n}\n\nexport default WorkerMessenger;\n","import { Message } from '../types.js';\nimport Messenger, {\n  InitializeMessengerOptions,\n  MessageHandler,\n} from './Messenger.js';\nimport PenpalError from '../PenpalError.js';\n\ntype Options = {\n  /**\n   * The port used to communicate to the other port of the port pair.\n   */\n  port: MessagePort;\n};\n\n/**\n * Handles the details of communicating on a MessagePort.\n */\nclass PortMessenger implements Messenger {\n  #port: MessagePort;\n  #validateReceivedMessage?: (data: unknown) => data is Message;\n  #messageCallbacks = new Set<MessageHandler>();\n\n  constructor({ port }: Options) {\n    if (!port) {\n      throw new PenpalError('INVALID_ARGUMENT', 'port must be defined');\n    }\n\n    this.#port = port;\n  }\n\n  initialize = ({ validateReceivedMessage }: InitializeMessengerOptions) => {\n    this.#validateReceivedMessage = validateReceivedMessage;\n    this.#port.addEventListener('message', this.#handleMessage);\n    this.#port.start();\n  };\n\n  sendMessage = (message: Message, transferables?: Transferable[]): void => {\n    this.#port?.postMessage(message, {\n      transfer: transferables,\n    });\n  };\n\n  addMessageHandler = (callback: MessageHandler): void => {\n    this.#messageCallbacks.add(callback);\n  };\n\n  removeMessageHandler = (callback: MessageHandler): void => {\n    this.#messageCallbacks.delete(callback);\n  };\n\n  destroy = () => {\n    this.#port.removeEventListener('message', this.#handleMessage);\n    this.#port.close();\n    this.#messageCallbacks.clear();\n  };\n\n  #handleMessage = ({ data }: MessageEvent): void => {\n    if (!this.#validateReceivedMessage?.(data)) {\n      return;\n    }\n\n    for (const callback of this.#messageCallbacks) {\n      callback(data);\n    }\n  };\n}\n\nexport default PortMessenger;\n","// Not intended to be used internally. Can be useful externally\n// in projects not using TypeScript. It has the `Obj` suffix to disambiguate\n// it from the ErrorCode string union.\nconst ErrorCodeObj = {\n  ConnectionDestroyed: 'CONNECTION_DESTROYED',\n  ConnectionTimeout: 'CONNECTION_TIMEOUT',\n  InvalidArgument: 'INVALID_ARGUMENT',\n  MethodCallTimeout: 'METHOD_CALL_TIMEOUT',\n  MethodNotFound: 'METHOD_NOT_FOUND',\n  TransmissionFailed: 'TRANSMISSION_FAILED',\n} as const;\n\nexport default ErrorCodeObj;\n","import { Log } from './types.js';\n\nconst debug = (prefix?: string): Log => {\n  return (...args: unknown[]) => {\n    console.log(` %c${prefix}%c`, 'font-weight: bold;', '', ...args);\n  };\n};\n\nexport default debug;\n"]}