var Penpal=function(e){"use strict";var t=class extends Error{code;constructor(e,t){super(t),this.name="PenpalError",this.code=e}},s=e=>({name:e.name,message:e.message,stack:e.stack,penpalCode:e instanceof t?e.code:void 0}),r=Symbol("Reply"),a=class{value;transferables;#e=r;constructor(e,t){this.value=e,this.transferables=t?.transferables}},n="penpal",o=e=>"object"==typeof e&&null!==e,i=e=>"function"==typeof e,l=e=>"SYN"===e.type,d=e=>"ACK1"===e.type,c=e=>"ACK2"===e.type,h=e=>"CALL"===e.type,g=e=>"REPLY"===e.type,m=(e,t=[])=>{const s=[];for(const r of Object.keys(e)){const a=e[r];i(a)?s.push([...t,r]):o(a)&&s.push(...m(a,[...t,r]))}return s},p=e=>e.join("."),u=(e,t,r)=>({namespace:n,channel:e,type:"REPLY",callId:t,isError:!0,...r instanceof Error?{value:s(r),isSerializedErrorInstance:!0}:{value:r}}),f=(e,s,r,l)=>{let d=!1;const c=async c=>{if(d)return;if(!h(c))return;l?.(`Received ${p(c.methodPath)}() call`,c);const{methodPath:g,args:m,id:f}=c;let v,M;try{const e=((e,t)=>{const s=e.reduce(((e,t)=>o(e)?e[t]:void 0),t);return i(s)?s:void 0})(g,s);if(!e)throw new t("METHOD_NOT_FOUND",`Method \`${p(g)}\` is not found.`);let l=await e(...m);l instanceof a&&(M=l.transferables,l=await l.value),v={namespace:n,channel:r,type:"REPLY",callId:f,value:l}}catch(e){v=u(r,f,e)}if(!d)try{l?.(`Sending ${p(g)}() reply`,v),e.sendMessage(v,M)}catch(t){throw"DataCloneError"===t.name&&(v=u(r,f,t),l?.(`Sending ${p(g)}() reply`,v),e.sendMessage(v)),t}};return e.addMessageHandler(c),()=>{d=!0,e.removeMessageHandler(c)}},v=crypto.randomUUID?.bind(crypto)??(()=>new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-")),M=Symbol("CallOptions"),w=class{transferables;timeout;#e=M;constructor(e){this.transferables=e?.transferables,this.timeout=e?.timeout}},y=new Set(["apply","call","bind"]),E=(e,t,s=[])=>new Proxy(s.length?()=>{}:Object.create(null),{get(r,a){if("then"!==a)return s.length&&y.has(a)?Reflect.get(r,a):E(e,t,[...s,a])},apply:(t,r,a)=>e(s,a)}),C=e=>new t("CONNECTION_DESTROYED",`Method call ${p(e)}() failed due to destroyed connection`),O=(e,s,r)=>{let a=!1;const o=new Map,i=e=>{if(!g(e))return;const{callId:s,value:a,isError:n,isSerializedErrorInstance:i}=e,l=o.get(s);l&&(o.delete(s),r?.(`Received ${p(l.methodPath)}() call`,e),n?l.reject(i?(({name:e,message:s,stack:r,penpalCode:a})=>{const n=a?new t(a,s):new Error(s);return n.name=e,n.stack=r,n})(a):a):l.resolve(a))};e.addMessageHandler(i);return{remoteProxy:E(((i,l)=>{if(a)throw C(i);const d=v(),c=l[l.length-1],h=c instanceof w,{timeout:g,transferables:m}=h?c:{},u=h?l.slice(0,-1):l;return new Promise(((a,l)=>{const c=void 0!==g?window.setTimeout((()=>{o.delete(d),l(new t("METHOD_CALL_TIMEOUT",`Method call ${p(i)}() timed out after ${g}ms`))}),g):void 0;o.set(d,{methodPath:i,resolve:a,reject:l,timeoutId:c});try{const t={namespace:n,channel:s,type:"CALL",id:d,methodPath:i,args:u};r?.(`Sending ${p(i)}() call`,t),e.sendMessage(t,m)}catch(e){l(new t("TRANSMISSION_FAILED",e.message))}}))}),r),destroy:()=>{a=!0,e.removeMessageHandler(i);for(const{methodPath:e,reject:t,timeoutId:s}of o.values())clearTimeout(s),t(C(e));o.clear()}}},I=()=>{let e,t;return{promise:new Promise(((s,r)=>{e=s,t=r})),resolve:e,reject:t}},R=class extends Error{constructor(e){super(`You've hit a bug in Penpal. Please file an issue with the following information: ${e}`)}},N="deprecated-penpal",S=e=>e.join("."),P=e=>new R(`Unexpected message to translate: ${JSON.stringify(e)}`),A=({messenger:e,methods:s,timeout:r,channel:a,log:o})=>{const i=v();let h;const g=[];let p=!1;const u=m(s),{promise:M,resolve:w,reject:y}=I(),E=void 0!==r?setTimeout((()=>{y(new t("CONNECTION_TIMEOUT",`Connection timed out after ${r}ms`))}),r):void 0,C=()=>{for(const e of g)e()},R=()=>{if(p)return;g.push(f(e,s,a,o));const{remoteProxy:t,destroy:r}=O(e,a,o);g.push(r),clearTimeout(E),p=!0,w({remoteProxy:t,destroy:C})},S=()=>{const s={namespace:n,type:"SYN",channel:a,participantId:i};o?.("Sending handshake SYN",s);try{e.sendMessage(s)}catch(e){y(new t("TRANSMISSION_FAILED",e.message))}},P=s=>{l(s)&&(s=>{if(o?.("Received handshake SYN",s),s.participantId===h&&h!==N)return;if(h=s.participantId,S(),!(i>h||h===N))return;const r={namespace:n,channel:a,type:"ACK1",methodPaths:u};o?.("Sending handshake ACK1",r);try{e.sendMessage(r)}catch(e){return void y(new t("TRANSMISSION_FAILED",e.message))}})(s),d(s)&&(s=>{o?.("Received handshake ACK1",s);const r={namespace:n,channel:a,type:"ACK2"};o?.("Sending handshake ACK2",r);try{e.sendMessage(r)}catch(e){return void y(new t("TRANSMISSION_FAILED",e.message))}R()})(s),c(s)&&(e=>{o?.("Received handshake ACK2",e),R()})(s)};return e.addMessageHandler(P),g.push((()=>e.removeMessageHandler(P))),S(),M},b=e=>{let t,s=!1;return(...r)=>(s||(s=!0,t=e(...r)),t)},T=new WeakSet,k=({messenger:e,methods:s={},timeout:r,channel:a,log:i})=>{if(!e)throw new t("INVALID_ARGUMENT","messenger must be defined");if(T.has(e))throw new t("INVALID_ARGUMENT","A messenger can only be used for a single connection");T.add(e);const l=[e.destroy],d=b((t=>{if(t){const t={namespace:n,channel:a,type:"DESTROY"};try{e.sendMessage(t)}catch(e){}}for(const e of l)e();i?.("Connection destroyed")})),c=e=>(e=>o(e)&&e.namespace===n)(e)&&e.channel===a;return{promise:(async()=>{try{e.initialize({log:i,validateReceivedMessage:c}),e.addMessageHandler((e=>{(e=>"DESTROY"===e.type)(e)&&d(!1)}));const{remoteProxy:t,destroy:n}=await A({messenger:e,methods:s,timeout:r,channel:a,log:i});return l.push(n),t}catch(e){throw d(!0),e}})(),destroy:()=>{d(!0)},getOrigin:()=>e.getConcreteRemoteOrigin?.()||""}},L=class{#t;#s;#r;#a;#n;#o=new Set;#i;#l=!1;constructor({remoteWindow:e,allowedOrigins:s}){if(!e)throw new t("INVALID_ARGUMENT","remoteWindow must be defined");this.#t=e,this.#s=s?.length?s:[window.origin]}initialize=({log:e,validateReceivedMessage:t})=>{this.#r=e,this.#a=t,window.addEventListener("message",this.#d)};sendMessage=(e,t)=>{if(l(e)){const s=this.#c(e);this.#t.postMessage(e,{targetOrigin:s,transfer:t})}else if(d(e)||this.#l){const s=this.#l?(e=>{if(d(e))return{penpal:"synAck",methodNames:e.methodPaths.map(S)};if(h(e))return{penpal:"call",id:e.id,methodName:S(e.methodPath),args:e.args};if(g(e))return e.isError?{penpal:"reply",id:e.callId,resolution:"rejected",...e.isSerializedErrorInstance?{returnValue:e.value,returnValueIsError:!0}:{returnValue:e.value}}:{penpal:"reply",id:e.callId,resolution:"fulfilled",returnValue:e.value};throw P(e)})(e):e,r=this.#c(e);this.#t.postMessage(s,{targetOrigin:r,transfer:t})}else if(c(e)){const{port1:s,port2:r}=new MessageChannel;this.#i=s,s.addEventListener("message",this.#h),s.start();const a=[r,...t||[]],n=this.#c(e);this.#t.postMessage(e,{targetOrigin:n,transfer:a})}else{if(!this.#i)throw new R("Port is undefined");this.#i.postMessage(e,{transfer:t})}};addMessageHandler=e=>{this.#o.add(e)};removeMessageHandler=e=>{this.#o.delete(e)};destroy=()=>{window.removeEventListener("message",this.#d),this.#g(),this.#o.clear()};getConcreteRemoteOrigin=()=>this.#n;#m=e=>this.#s.some((t=>t instanceof RegExp?t.test(e):t===e||"*"===t));#c=e=>{if(l(e))return"*";if(!this.#n)throw new R("Concrete remote origin not set");return"null"===this.#n&&this.#s.includes("*")?"*":this.#n};#g=()=>{this.#i?.removeEventListener("message",this.#h),this.#i?.close(),this.#i=void 0};#d=({source:e,origin:t,ports:s,data:r})=>{if(e===this.#t&&((e=>o(e)&&"penpal"in e)(r)&&(this.#r?.("Please upgrade the child window to the latest version of Penpal."),this.#l=!0,r=(e=>{if("syn"===e.penpal)return{namespace:n,channel:void 0,type:"SYN",participantId:N};if("ack"===e.penpal)return{namespace:n,channel:void 0,type:"ACK2"};if("call"===e.penpal)return{namespace:n,channel:void 0,type:"CALL",id:e.id,methodPath:(t=e.methodName,t.split(".")),args:e.args};var t;if("reply"===e.penpal)return"fulfilled"===e.resolution?{namespace:n,channel:void 0,type:"REPLY",callId:e.id,value:e.returnValue}:{namespace:n,channel:void 0,type:"REPLY",callId:e.id,isError:!0,...e.returnValueIsError?{value:e.returnValue,isSerializedErrorInstance:!0}:{value:e.returnValue}};throw P(e)})(r)),this.#a?.(r)))if(this.#m(t)){if(l(r)&&(this.#g(),this.#n=t),c(r)&&!this.#l){if(this.#i=s[0],!this.#i)throw new R("No port received on ACK2");this.#i.addEventListener("message",this.#h),this.#i.start()}for(const e of this.#o)e(r)}else this.#r?.(`Received a message from origin \`${t}\` which did not match allowed origins \`[${this.#s.join(", ")}]\``)};#h=({data:e})=>{if(this.#a?.(e))for(const t of this.#o)t(e)}},D=class{#p;#a;#o=new Set;#i;constructor({worker:e}){if(!e)throw new t("INVALID_ARGUMENT","worker must be defined");this.#p=e}initialize=({validateReceivedMessage:e})=>{this.#a=e,this.#p.addEventListener("message",this.#u)};sendMessage=(e,t)=>{if(l(e)||d(e))this.#p.postMessage(e,{transfer:t});else{if(c(e)){const{port1:s,port2:r}=new MessageChannel;return this.#i=s,s.addEventListener("message",this.#u),s.start(),void this.#p.postMessage(e,{transfer:[r,...t||[]]})}if(!this.#i)throw new R("Port is undefined");this.#i.postMessage(e,{transfer:t})}};addMessageHandler=e=>{this.#o.add(e)};removeMessageHandler=e=>{this.#o.delete(e)};destroy=()=>{this.#p.removeEventListener("message",this.#u),this.#g(),this.#o.clear()};#g=()=>{this.#i?.removeEventListener("message",this.#u),this.#i?.close(),this.#i=void 0};#u=({ports:e,data:t})=>{if(this.#a?.(t)){if(l(t)&&this.#g(),c(t)){if(this.#i=e[0],!this.#i)throw new R("No port received on ACK2");this.#i.addEventListener("message",this.#u),this.#i.start()}for(const e of this.#o)e(t)}}},_=class{#i;#a;#o=new Set;constructor({port:e}){if(!e)throw new t("INVALID_ARGUMENT","port must be defined");this.#i=e}initialize=({validateReceivedMessage:e})=>{this.#a=e,this.#i.addEventListener("message",this.#u),this.#i.start()};sendMessage=(e,t)=>{this.#i?.postMessage(e,{transfer:t})};addMessageHandler=e=>{this.#o.add(e)};removeMessageHandler=e=>{this.#o.delete(e)};destroy=()=>{this.#i.removeEventListener("message",this.#u),this.#i.close(),this.#o.clear()};#u=({data:e})=>{if(this.#a?.(e))for(const t of this.#o)t(e)}},F={ConnectionDestroyed:"CONNECTION_DESTROYED",ConnectionTimeout:"CONNECTION_TIMEOUT",InvalidArgument:"INVALID_ARGUMENT",MethodCallTimeout:"METHOD_CALL_TIMEOUT",MethodNotFound:"METHOD_NOT_FOUND",TransmissionFailed:"TRANSMISSION_FAILED"},U=e=>(...t)=>{console.log(`✍️ %c${e}%c`,"font-weight: bold;","",...t)};return e.CallOptions=w,e.ErrorCode=F,e.PenpalError=t,e.PortMessenger=_,e.Reply=a,e.WindowMessenger=L,e.WorkerMessenger=D,e.connect=k,e.debug=U,e}({});//# sourceMappingURL=penpal.min.js.map